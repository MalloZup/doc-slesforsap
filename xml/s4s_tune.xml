<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha.s4s.tune">
 <title>Tuning</title>

 <para>
  This chapter presents information about tuning &s4sa; to work optimally with
  &sap; applications.
 </para>

 <sect1 xml:id="sec.s4s.configure.page-cache">
  <title>Kernel: Page-Cache Limit</title>
  <remark>
   The presentation of Problem/Solution is on one hand quite useful, on the
   other it is very inconsistent with the rest of this chapter.
   - sknorr, 2016-02-12
  </remark>
  <variablelist>
   <varlistentry>
    <term>Problem</term>
    <listitem>
     <para>
      The kernel swaps out rarely accessed memory pages to use
      freed memory pages as cache to speed up file system operations, for
      example during backup operations.
     </para>
     <para>
      &netweaver; and &hana; use large amounts of memory for accelerated access
      to business data. Parts of this memory are rarely accessed. When a
      user request needs to access paged-out memory, the response time
      is poor. It is even worse when an &sap; application running on Java incurs
      a Java garbage collection: The system starts heavy page-in (disk I/O)
      activity and has a poor response time for an extended period of time.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Solution</term>
    <listitem>
     <para>
      &sles4sap; includes a kernel tuning option that allows the system
      administrator to limit the amount of page cache that the kernel uses
      when there is competition between application memory and page cache.
      This option tells the kernel that when the page cache is filled to the
      configured limit, application memory is more important and should thus
      not be paged out. No pages will be paged out if the memory footprint
      of the workload plus the configured page-cache limit do not exceed the
      amount of physical RAM in the system.
     </para>
     <para>
      These kernel options are available for configuration:
     </para>
     <itemizedlist>
      <listitem>
       <para>
        <literal>vm.pagecache_limit_mb</literal>
        (<filename>/proc/sys/vm/pagecache_limit_mb</filename>)
       </para>
      </listitem>
      <listitem>
       <para>
        <literal>vm.pagecache_limit_ignore_dirty</literal>
        (<filename>/proc/sys/vm/pagecache_limit_ignore_dirty</filename>)
       </para>
      </listitem>
     </itemizedlist>
     <tip>
      <title>
       Use &saptune; to Configure Parameters
      </title>
      <para>
       The parameters <literal>vm.pagecache_limit_mb</literal> and
       <literal>vm.pagecache_limit_ignore_dirty</literal> are also configured by
       the &tuned; profiles delivered with &saptune;.
      </para>
      <para>
       For more information, see <xref linkend="sec.saptune"/>.
      </para>
     </tip>
     <important>
      <title>The Following Are Example Values</title>
      <para>
       The values reproduced in <xref linkend="ex.s4s.page-cache"/> are example
       values only. Do not set the following parameters on a productive system
       without first trying and calibrating them on a non-productive system.
      </para>
      <para>
       If your system does not exhibit page-cache limit issues under the
       workloads it is running, there is no need to adjust these parameters.
      </para>
      <para>
       For more information, see <citetitle>SAP Note 1557506: Linux Paging
       Improvements</citetitle>
       (<link xlink:href="&sapnoteaddress;1557506"/>).
     </para>
     </important>
     <example xml:id="ex.s4s.page-cache">
      <title>Permanently Setting the Page-Cache Limit</title>
      <para>
       For permanent use, add both parameters to
       <filename>/etc/sysctl.conf</filename>, for example:
      </para>
<screen>vm.pagecache_limit_mb = <replaceable>1024</replaceable>
vm.pagecache_limit_ignore_dirty = <replaceable>2</replaceable></screen>
     </example>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec.sapconf">
  <title>Tuning Systems with the &sapconf; Profile</title>
  <para>
   The package <systemitem>sapconf</systemitem> contains the
   <systemitem>tuned</systemitem> profile <literal>sapconf-netweaver</literal>.
   This single tuning profile sets recommended parameters for the following
   types of &sap; applications: &netweaver;, &hana; and &hana;-based
   applications, &ase;, and &bo;.
  </para>
  <para>
   Note that if you previously made changes to the system tuning, those
   changes may be overwritten by the <literal>sapconf-netweaver</literal>
   profile.
  </para>
  <para>
   To use &sapconf;, make sure
   that the package <package>sapconf</package> is installed on your system.
  </para>
  <note>
   <title><command>sapconf</command> Utility Is Not Included in &productname; &productnumber;</title>
   <para>
    The command-line utility <command>sapconf</command> that was included
    &productname; 11 and 12 is not available anymore in
    &productname; &productnumber;.
   </para>
  </note>
  <note>
   <title>Unified Profiles in &productname; 15</title>
   <para>
    In &productname; 15 and up, only a single &tuned; profile,
    <literal>sapconf</literal>, is shipped. It is equivalent to the profiles
    <literal>sap-hana</literal>/<literal>sap-netweaver</literal> (both
    profiles are identical) that are shipped with &sapconf; 4.1.11 (and
    later) in &productname; &productnumber;.
   </para>
  </note>
  <sect2 xml:id="sec.sapconf.enable">
   <title>Enabling and Disabling &sapconf;</title>
   <para>
    After the installation of &sapconf;, &tuned; is already enabled and
    the &sapconf; profile is active unless a different &tuned; profile is in
    use already. In a sense, installing &sapconf; is interpreted as intent to
    use it.
   </para>
   <para>
    However, for &sapconf; to apply all tuning parameters, make sure to
    reboot the machine after installation.
   </para>
   <para>
    To see the status of &tuned;, use:
   </para>
   <screen>&prompt.root;<command>systemctl status tuned</command></screen>
   <para>
    If &tuned; is not shown as <literal>active (enabled)</literal>, enable and
    start &tuned;:
   </para>
   <screen>&prompt.root;<command>systemctl enable --now tuned</command></screen>
   <para>
    To see which &tuned; profile is currently in use, run:
   </para>
<screen>&prompt.root;<command>tuned-adm active</command></screen>
   <para>
    If this command does not return the name of the currently active profile
    as <literal>sapconf</literal>, enable that profile:
   </para>
   <screen>&prompt.root;<command>tuned-adm profile sapconf</command></screen>
   <para>
    To disable daemon &tuned;, run:
   </para>
   <screen>&prompt.root;<command>systemctl disable tuned</command></screen>
   <tip>
    <title>Additional Services that &sapconf; Relies On</title>
    <para>
     In addition to &sapconf; service itself and the &tuned; service, &sapconf;
     also relies on the following two services:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <systemitem class="daemon">sysstat</systemitem> to collect data on
       system activity
      </para>
     </listitem>
     <listitem>
      <para>
       <systemitem class="daemon">uuidd</systemitem> which generates time-based
       UUIDs that are guaranteed to be unique even in settings where many
       processor cores are involved.
      </para>
     </listitem>
    </itemizedlist>
   </tip>
  </sect2>
  <sect2 xml:id="sec.sapconf.configure">
   <title>Configuring &sapconf;</title>
   <para>
    You can configure &sapconf; to better fit your needs using the
    configuration file <filename>/etc/sysconfig/sapconf</filename> and
    associated <filename>/etc/sysconfig/sapnote-*</filename> files. These file
    contain options for the tuning parameters that are set by &sapconf;, along
    with descriptions of what the parameters do and further references.
   </para>
   <para>
    To apply the new configuration, restart &sapconf;:
   </para>
   <screen>&prompt.root;<command>systemctl restart sapconf</command></screen>
   <para>
    To confirm the settings &sapconf; is applying, see the log files
    <filename>/var/log/sapconf.log</filename> and
    <filename>/var/log/tuned/tuned.log</filename>.
   </para>
   <para>
    To confirm the values currently in use for parameters configured under
    <filename>/proc/sys</filename>, use, for example:
   </para>
   <screen>&prompt.root;<command>sysctl net.ipv4.tcp_slow_start_after_idle</command></screen>
   <para>
    Values written to other parts of the file system need to be confirmed in
    other ways.
   </para>
  </sect2>
  <sect2 xml:id="sec.sapconf.remove">
   <title>Removing &sapconf;</title>
   <para>
    To remove &sapconf; from a system, uninstall its package with:
   </para>
   <screen>&prompt.root;<command>zypper rm sapconf</command></screen>
   <para>
    Note that when doing this, dependencies of &sapconf; will remain installed.
    However, the service <systemitem class="daemon">sysstat</systemitem> will
    go into a disabled state. If it is still relevant to you, make sure to
    enable it again.
   </para>
  </sect2>
  <sect2 xml:id="sec.sapconf.more">
   <title>For More Information</title>
   <para>
    The following man pages provide additional information about &sapconf;:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      High-level overview of tuning parameters used by &sapconf;:
      <command>man 7 tuned-profiles-sapconf</command>
     </para>
    </listitem>
    <listitem>
     <para>
      Detailed description of all tuning parameters set by &sapconf;:
      <command>man 5 sapconf</command>
     </para>
    </listitem>
    <listitem>
     <para>
      Information about configuring and customizing the &sapconf; profile:
      <command>man 7 sapconf</command>
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Also see the blog series detailing the updated version of &sapconf; at
    <link xlink:href="https://www.suse.com/c/a-new-sapconf-is-available/"/>.
   </para>
  </sect2>
 </sect1>

 <sect1 xml:id="sec.saptune">
  <title>Tuning Systems with &saptune;</title>
  <para>
   Using &saptune;, you can
   tune a system for &netweaver;, &hana;/&b1;, and &s4h; applications. This method
   relies on the system tuning service &tuned;.
   However, the preferred method to tune systems for &sap; workloads is
   using &sapconf; (see <xref linkend="sec.sapconf"/>).
  </para>
  <para>
   If you used the &sapwiz; to install an &sap; application,
   &tuned; is usually already active and configured with
   a profile for the application you installed.
  </para>
  <para>
   If you did not use the &sapwiz; to install an &sap; application, make sure
   that the packages <package>tuned</package> and
   <package>saptune</package> are installed on your system.
  </para>

  <sect2 xml:id="sec.s4s.saptune.enable">
  <title>Enabling &saptune; to Tune for an &sap; Application</title>
  <procedure xml:id="pro.s4s.tune">
   <step>
    <para>
     To tune a system, first find a tuning profile.
     To find the appropriate profile, use:
    </para>
    <screen>&prompt.user;<command>saptune solution list</command></screen>
    <para>
     &saptune; knows the following
     <quote>solution</quote> profiles:
    </para>
    <itemizedlist>
     <listitem>
      <formalpara>
       <title><literal>BOBJ</literal></title>
       <para>
        Profile for servers hosting &bo;.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>HANA</literal></title>
       <para>
        Profile for servers hosting an &hana; database.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>MAXDB</literal></title>
       <para>
        Profile for servers hosting a MaxDB database.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>NETWEAVER</literal></title>
       <para>
        Profile for servers hosting an &netweaver; application.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>S4HANA-APPSERVER</literal></title>
       <para>
        Profile for servers hosting an &s4h; application.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>S4HANA-DBSERVER</literal></title>
       <para>
        Profile for servers hosting the &hana; database of an &s4h;
        installation.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>SAP-ASE</literal></title>
       <para>
        Profile for servers hosting an &ase; database (formerly Sybase
        Adaptive Server Enterprise).
        <!-- SAP bought Sybase in 2010, really keep "Sybase" in here? -
        sknorr, 2017-07-04 -->
       </para>
      </formalpara>
     </listitem>
    </itemizedlist>
    <para>
     Alternatively, you can tune the computer according to recommendations
     from specific &sap; Notes. A list of notes that you can tune for is
     available via:
    </para>
    <screen>&prompt.root;<command>saptune note list</command></screen>
    <para>
     The referenced &sap; Notes are available from the &sap; Web site.
     The list entries starting with <literal>SUSE-GUIDE</literal> follow the
     recommendations made in
     <link xlink:href="https://www.suse.com/communities/blog/sles-1112-os-tuning-optimisation-guide-part-1/"/>
     and
     <link xlink:href="https://www.suse.com/communities/blog/sles-1112-network-cpu-tuning-optimization-part-2/"/>.
    </para>
   </step>
   <step>
    <itemizedlist>
     <listitem>
      <para>
       To set up &saptune; with a preconfigured solution, use:
      </para>
      <screen>&prompt.root;<command>saptune solution apply <replaceable>SOLUTION</replaceable></command></screen>
     </listitem>
     <listitem>
      <para>
       To set up &saptune; for the recommendations of a specific
       &sap; Note, use:
      </para>
      <screen>&prompt.root;<command>saptune note apply <replaceable>NOTE</replaceable></command></screen>
     </listitem>
    </itemizedlist>
    <tip>
     <title>Combining Optimizations</title>
     <para>
      You can freely combine <quote>solutions</quote> and
      <quote>notes.</quote> Combining multiple optimizations will never create
      conflicts.
     </para>
    </tip>
   </step>
   <step>
    <para>
     Finally, enable the &tuned; profile
     &saptune; and make sure the
     &tuned; daemon is active:
    </para>
    <screen>&prompt.root;<command>saptune daemon start</command></screen>
   </step>
  </procedure>
  <para>
   In the background, &saptune; applies a
   &tuned; profile also named
   &saptune; that is dynamically customized according to
   selected <quote>solutions</quote> and <quote>notes</quote>.
   Using <command>tuned-adm list</command>, you can also see this profile.
  </para>
  </sect2>
  <sect2 xml:id="sec.s4s.saptune.disable">
   <title>Disabling &saptune;</title>
   <para>
    To disable &saptune;, use one of the following ways:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Completely disable the daemon
      &tuned;:
     </para>
     <screen>&prompt.root;<command>systemctl disable tuned</command></screen>
    </listitem>
    <listitem>
     <para>
      Switch to a different
      &tuned; profile:
     </para>
     <screen>&prompt.root;<command>tuned-adm profile <replaceable>PROFILE_NAME</replaceable></command></screen>
    </listitem>
   </itemizedlist>
  </sect2>
  <sect2 xml:id="sec.s4s.saptune.manual">
   <title>Tuning Kernel Parameters Manually Using <command>sysctl</command></title>
   <para>
    In addition to or instead of tuning kernel parameters using
    &saptune;, you can also use <command>sysctl</command> to
    make manual adjustments to kernel parameters. However, such changes using
    <command>sysctl</command> do not persist across reboots by default. To
    make them persist across reboots, add them to the file
    <filename>/etc/sysctl.conf</filename> (or another configuration file read
    by <command>sysctl</command>).
   </para>
   <para>
    <!-- FIXME: -> SLES docs: we don't seem to have any good section to
    reference here. Thisll do for the moment. - sknorr, 2017-05-04 -->
    For more information about <command>sysctl</command>, see the man pages
    <literal>sysctl(8)</literal>, <literal>sysctl.conf(5)</literal>, and
    <literal>sysctl.d(5)</literal>.
   </para>
  </sect2>


  <sect2 xml:id="sec.saptune.more">
   <title>For More Information</title>
  <para>
   See the following man pages:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     <command>man 8 tuned-adm</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man 8 saptune</command>
    </para>
   </listitem>
  </itemizedlist>
  <para>
   Also see the project home page
   <link xlink:href="https://github.com/HouzuoGuo/saptune/"/>.
  </para>
  </sect2>
 </sect1>

</chapter>
